
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Maze Duo FPS - FIXED</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #000; z-index: 100; color: #0f0; }
        .menu { border: 2px solid #0f0; padding: 30px; text-align: center; background: #050505; }
        button { background: #0f0; color: #000; border: none; padding: 15px 30px; cursor: pointer; font-weight: bold; font-size: 20px; }
        #hud { position: absolute; top: 10px; left: 10px; color: #0f0; z-index: 10; font-size: 18px; pointer-events: none; }
    </style>
</head>
<body>

<div id="ui">
    <div class="menu">
        <h1>MAZE DUO 3D</h1>
        <button id="btnJogar">CLIQUE PARA INICIAR</button>
        <p>W, A, S, D para andar<br>Q para travar o mouse</p>
    </div>
</div>

<div id="hud">Aperte o botão verde</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
let scene, camera, renderer, socket, side = 'A', player, partner;
let walls = [], exitBox, gameIniciado = false;
let move = { fwd: false, bck: false, lft: false, rgt: false };
let yaw = 0, currentLevel = 1;

// Inicialização forçada do Three.js
function init3D() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000010);
    scene.fog = new THREE.Fog(0x000000, 1, 20);
    
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const light = new THREE.PointLight(0x00ff00, 2, 12);
    player = new THREE.Group();
    player.position.set(1.5, 1.2, 1.5);
    player.add(light);
    scene.add(player);

    partner = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({color: 0x00ffff}));
    scene.add(partner);
    
    createMaze(15);
    animate();
}

function createMaze(size) {
    // Limpa paredes antigas
    walls.forEach(w => scene.remove(w));
    walls = [];

    const geo = new THREE.BoxGeometry(1, 3, 1);
    const mat = new THREE.MeshStandardMaterial({ color: 0x222244 });

    for(let z=0; z<size; z++) {
        for(let x=0; x<size; x++) {
            if(Math.random() > 0.7 && !(x<3 && z<3)) { // Gera paredes aleatórias exceto no spawn
                const w = new THREE.Mesh(geo, mat);
                w.position.set(x, 1.5, z);
                scene.add(w);
                walls.push(new THREE.Box3().setFromObject(w));
            }
        }
    }
    // Chão
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshStandardMaterial({color:0x111111}));
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);
    scene.add(new THREE.AmbientLight(0xffffff, 0.2));
}

function animate() {
    requestAnimationFrame(animate);
    if(!gameIniciado) return;

    player.rotation.y = yaw;
    let oldPos = player.position.clone();
    
    let vel = new THREE.Vector3();
    if (move.fwd) vel.z -= 0.12;
    if (move.bck) vel.z += 0.12;
    if (move.lft) vel.x -= 0.12;
    if (move.rgt) vel.x += 0.12;

    vel.applyQuaternion(player.quaternion);
    player.position.add(vel);

    // Colisão
    let pBox = new THREE.Box3().setFromCenterAndSize(player.position, new THREE.Vector3(0.5, 1, 0.5));
    for (let wall of walls) {
        if (pBox.intersectsBox(wall)) {
            player.position.copy(oldPos);
            break;
        }
    }

    camera.position.copy(player.position);
    camera.rotation.y = yaw;

    if (socket && socket.readyState === 1) {
        socket.send(JSON.stringify({ type: 'move', side, x: player.position.x, z: player.position.z }));
    }

    renderer.render(scene, camera);
}

// Eventos de teclado
window.addEventListener('keydown', (e) => {
    let k = e.key.toLowerCase();
    if(k === 'w') move.fwd = true;
    if(k === 's') move.bck = true;
    if(k === 'a') move.lft = true;
    if(k === 'd') move.rgt = true;
    if(k === 'q') document.body.requestPointerLock();
});

window.addEventListener('keyup', (e) => {
    let k = e.key.toLowerCase();
    if(k === 'w') move.fwd = false;
    if(k === 's') move.bck = false;
    if(k === 'a') move.lft = false;
    if(k === 'd') move.rgt = false;
});

document.addEventListener('mousemove', (e) => {
    if (document.pointerLockElement === document.body) {
        yaw -= e.movementX * 0.002;
    }
});

document.getElementById('btnJogar').onclick = () => {
    gameIniciado = true;
    document.getElementById('ui').style.display = 'none';
    document.getElementById('hud').innerText = "Jogando...";
    
    // Inicia Socket em segundo plano
    socket = new WebSocket('wss://labirint-dou-coop.onrender.com');
    socket.onmessage = (msg) => {
        let data = JSON.parse(msg.data);
        if(data.type === 'move' && partner) partner.position.set(data.x, 0.5, data.z);
    };
};

// Inicia o motor gráfico ao carregar a página
window.onload = init3D;
</script>
</body>
</html>