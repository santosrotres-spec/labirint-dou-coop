<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Labirinto Duo 3D - Final</title>
    <style>
        body { margin: 0; overflow: hidden; background: #aaaaaa; font-family: sans-serif; }
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a1a; display: flex; align-items: center; justify-content: center; z-index: 1000; color: white; }
        .login-box { background: #161625; padding: 40px; border-radius: 10px; text-align: center; border: 2px solid #4444ff; }
        input { display: block; width: 250px; padding: 12px; margin: 10px auto; border-radius: 5px; border: none; font-size: 16px; }
        button { width: 275px; padding: 12px; background: #4444ff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #mapa { position: absolute; bottom: 20px; right: 20px; width: 150px; height: 150px; background: rgba(0,0,0,0.5); border: 2px solid #000; display: none; }
    </style>
</head>
<body>

<div id="ui-overlay">
    <div class="login-box">
        <h1>MAZE DUO 3D</h1>
        <p>Digite o código da sala para começar:</p>
        <input type="text" id="sala" placeholder="Ex: 123" value="123">
        <button id="btn-jogar">JOGAR AGORA</button>
        <p id="status-log" style="color: #00ff00; font-size: 14px; margin-top: 10px;"></p>
    </div>
</div>

<div id="mapa"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
let scene, camera, renderer, socket, side, goal;
let playerA, playerB, maze = [];
let wallMeshes = [];
let move = { fwd: false, bck: false, lft: false, rgt: false };
const mazeSize = 41;
let gameFinished = false;

function generateMaze(seed) {
    let m = Array(mazeSize).fill().map(() => Array(mazeSize).fill(1));
    function random(s) { let x = Math.sin(s) * 10000; return x - Math.floor(x); }
    function walk(x, y, s) {
        m[y][x] = 0;
        let dirs = [[0,2],[0,-2],[2,0],[-2,0]].sort(() => random(s++) - 0.5);
        dirs.forEach(([dx, dy]) => {
            let nx = x + dx, ny = y + dy;
            if (nx > 0 && nx < mazeSize && ny > 0 && ny < mazeSize && m[ny][nx] === 1) {
                m[y + dy/2][x + dx/2] = 0;
                walk(nx, ny, s + 1);
            }
        });
    }
    walk(1, 1, seed);
    return m;
}

document.getElementById('btn-jogar').onclick = function() {
    const sala = document.getElementById('sala').value;
    const log = document.getElementById('status-log');
    log.innerText = "Conectando...";
    
    maze = generateMaze(parseInt(sala) || 123);
    
    // VERIFIQUE SE ESTE LINK ESTÁ IGUAL AO DO SEU RENDER:
    socket = new WebSocket('wss://labirint-dou-coop.onrender.com');

    socket.onopen = () => {
        socket.send(JSON.stringify({ type: 'join', token: sala }));
        document.getElementById('ui-overlay').style.display = 'none';
        document.getElementById('mapa').style.display = 'block';
        init3D();
    };

    socket.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if (data.type === 'start') side = data.side;
        if (data.type === 'move') {
            const target = data.side === 'A' ? playerA : playerB;
            if(target) target.position.set(data.x, 0.5, data.z);
        }
    };
};

function init3D() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xaaaaaa); // FUNDO CLARO

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // LUZ FORTE
    const light = new THREE.AmbientLight(0xffffff, 2.0); 
    scene.add(light);
    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
    sun.position.set(5, 10, 7);
    scene.add(sun);

    const wallGeo = new THREE.BoxGeometry(2, 2, 2);
    const wallMat = new THREE.MeshStandardMaterial({ color: 0x4444ff });

    maze.forEach((row, z) => {
        row.forEach((val, x) => {
            if (val === 1) {
                const wall = new THREE.Mesh(wallGeo, wallMat);
                wall.position.set(x * 2 - mazeSize, 1, z * 2 - mazeSize);
                scene.add(wall);
                wallMeshes.push(wall);
            }
        });
    });

    // CHEGADA (BLOCO VERDE)
    const goalGeo = new THREE.BoxGeometry(2, 0.2, 2);
    const goalMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
    goal = new THREE.Mesh(goalGeo, goalMat);
    goal.position.set((mazeSize-2)*2 - mazeSize, 0.1, (mazeSize-2)*2 - mazeSize);
    scene.add(goal);

    playerA = new THREE.Mesh(new THREE.SphereGeometry(0.7), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
    playerB = new THREE.Mesh(new THREE.SphereGeometry(0.7), new THREE.MeshStandardMaterial({ color: 0x00ffff }));
    scene.add(playerA, playerB);

    animate();
}

window.onkeydown = (e) => { const k = e.key.toLowerCase(); if(k==='w') move.fwd=true; if(k==='s') move.bck=true; if(k==='a') move.lft=true; if(k==='d') move.rgt=true; };
window.onkeyup = (e) => { const k = e.key.toLowerCase(); if(k==='w') move.fwd=false; if(k==='s') move.bck=false; if(k==='a') move.lft=false; if(k==='d') move.rgt=false; };

function animate() {
    requestAnimationFrame(animate);
    if (!side || gameFinished) return;

    const p = side === 'A' ? playerA : playerB;
    const oldPos = p.position.clone();

    if (move.fwd) p.position.z -= 0.2;
    if (move.bck) p.position.z += 0.2;
    if (move.lft) p.position.x -= 0.2;
    if (move.rgt) p.position.x += 0.2;

    wallMeshes.forEach(w => {
        if (p.position.distanceTo(w.position) < 1.4) p.position.copy(oldPos);
    });

    // VERIFICAR VITÓRIA
    if (p.position.distanceTo(goal.position) < 1.5) {
        gameFinished = true;
        alert("VITÓRIA! VOCÊS CONSEGUIRAM!");
        location.reload();
    }

    camera.position.set(p.position.x, 12, p.position.z + 6);
    camera.lookAt(p.position);
    
    if (socket.readyState === 1) {
        socket.send(JSON.stringify({ type: 'move', side, x: p.position.x, z: p.position.z }));
    }
    renderer.render(scene, camera);
}
</script>
</body>
</html>